# Описание задания

## Задание 1

### 1. Дополнить модель проекта:
#### Сущность Account:
- id клиента
- Дебетовый счет или кредитный (enum)
- Баланс

#### Сущность Transaction:
- id счета
- Сумма транзакции
- Время транзакции

#### Сущность DataSourceErrorLog:
- Текст стектрейса исключения
- Сообщение
- Сигнатура метода

### 1.1 Контроллеры к Account и Transaction

### 2. Генерация данных
- Сгенерировать набор данных по сущностям. Можно написать генератор самостоятельно или использовать сервисы, аналогичные https://www.mockaroo.com/.

### 3. Разработка аспекта:

#### 3.1 Аспект @LogDataSourceError
- Логирует сообщения об исключениях путем создания в БД новой записи DataSourceErrorLog в случае возникновения ошибки при выполнении CRUD-операций над сущностями.

## Задание 2

### 1. Изменение аспекта @LogDataSourceError:
- В первую очередь аспект должен отсылать сообщение в топик `t1_demo_metrics`.
- В заголовке должно указываться: `Тип ошибки: DATA_SOURCE`.
- В случае неудачи отправки — записать в БД.

### 2. Разработка аспекта @Metric:
- Принимает в качестве значения время в миллисекундах.
- Если время работы метода превышает заданное значение, аспект отправляет сообщение в топик Kafka `t1_demo_metrics`.
- Сообщение должно содержать:
  - Время работы
  - Имя метода
  - Параметры метода (если имеются)
- В заголовке передать `Тип ошибки: METRICS`.

### 3. Реализация консьюмеров:
- Разработать 2 консьюмера для топиков `t1_demo_accounts` и `t1_demo_transactions`.
- При получении сообщения сервис должен сохранять счет и транзакцию в БД.
- В качестве ключей сообщений можно использовать случайный UUID.

## Задание 3

### 1. Дополнение сущностей

#### 1.1 Сущность Transaction:
- Добавить статус [ACCEPTED, REJECTED, BLOCKED, CANCELLED, REQUESTED]
- Добавить уникальный `transactionId`
- Добавить `timestamp`

#### 1.2 Сущность Account:
- Добавить статус [ARRESTED, BLOCKED, CLOSED, OPEN]
- Добавить уникальный `accountId`
- Добавить поле `frozenAmount`

#### 1.3 Сущность Client:
- Добавить уникальный `clientId`

### 2. Обработка транзакций
- При получении сообщения из топика `t1_demo_transactions`:
  - Проверяется статус счета. Если статус `OPEN`, то:
    - Сохраняется транзакция в БД со статусом `REQUESTED`
    - Изменяется счет клиента на сумму транзакции
    - Отправляется сообщение в топик `t1_demo_transaction_accept` с информацией:
      `{clientId, accountId, transactionId, timestamp, transaction.amount, account.balance}`

### 3. Разработка сервиса 2 (отдельное приложение):
- Сервис слушает топик `t1_demo_transaction_accept`.
- При получении сообщения:
  - Если транзакции по одному и тому же клиенту и счету приходят больше `N` раз в `T` времени (конфигурируется) и `timestamp` транзакции попадает в этот период:
    - `N` транзакциям присваивается статус `BLOCKED`
    - Сообщение с `id счета`, `id транзакции` и `статусом` отправляется в `t1_demo_transaction_result`
  - Если сумма списания в транзакции больше, чем баланс счета — отправляется сообщение со статусом `REJECTED`
  - Если проверка проходит успешно, транзакция получает статус `ACCEPTED`

### 4. Обработка результатов транзакций
- `Сервис 1` теперь также слушает `t1_demo_transaction_result`.
- При получении сообщения:
  - Если статус `ACCEPTED` — обновляет статус транзакции в БД.
  - Если статус `BLOCKED`:
    - Обновляет статус транзакций в БД.
    - Выставляет счету статус `BLOCKED`.
    - Корректирует баланс счета, учитывая `frozenAmount`.
  - Если статус `REJECTED`:
    - Обновляет статус транзакции.
    - Корректирует баланс счета на сумму транзакции.

## Размещение в Git
- Выполненное задание выложить в репозиторий и прислать ссылку на PR.
- Убедиться, что репозиторий расшарен на чтение.
